{% extends "base.html" %}
{% block title %}{{ dept }} — Tasks{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">{{ dept }} Department</h3>
    <small class="text-muted">Tasks, updates & actions</small>
  </div>

  <a href="{{ url_for('department_dashboard', dept_name=dept) }}" class="btn btn-icici">
    View Dashboard
  </a>
</div>

<!-- FILTER BAR -->
<form method="get" class="d-flex gap-2 mb-3 filter-row">

  <select name="status" class="form-select">
    <option value="">All status</option>
    <option value="pending" {% if status_filter=='pending' %}selected{% endif %}>Pending</option>
    <option value="resolved" {% if status_filter=='resolved' %}selected{% endif %}>Resolved</option>
  </select>

  <select name="priority" class="form-select">
    <option value="">All priority</option>
    <option value="high" {% if priority_filter=='high' %}selected{% endif %}>High</option>
    <option value="medium" {% if priority_filter=='medium' %}selected{% endif %}>Medium</option>
    <option value="low" {% if priority_filter=='low' %}selected{% endif %}>Low</option>
  </select>

  <input type="text" name="email" class="form-control"
         placeholder="Filter by sender email"
         value="{{ email_filter or '' }}">

  <button class="btn btn-icici" type="submit">Apply</button>
  <a class="btn btn-outline-icici" href="{{ url_for('department_view', dept_name=dept) }}">Reset</a>
</form>

<div class="table-responsive">
  <table class="table table-hover align-middle icici-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Type</th>
        <th>Owner</th>
        <th>Time</th>
        <th>Status</th>
        <th>Priority</th>
        <th>Created</th>
        <th>Summary</th>
        <th>Updates</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for p in projects %}
      <tr id="project-row-{{ p.id }}">
        <td>{{ p.id }}</td>
        <td>{{ p.project_type }}</td>
        <td>{{ p.owner_email }}</td>
        <td>{{ p.time_required or 'Not specified' }}</td>
        <td>
          {% if p.status and p.status|lower == 'resolved' %}
            <span class="badge bg-success">resolved</span>
          {% else %}
            <span class="badge bg-warning text-dark">{{ p.status or 'pending' }}</span>
          {% endif %}
        </td>
        <td>
          {% if p.priority %}
            {% set pri = p.priority.lower() %}
            {% if pri == 'high' %}
              <span class="badge badge-priority-high">HIGH</span>
            {% elif pri == 'medium' %}
              <span class="badge badge-priority-medium">MED</span>
            {% else %}
              <span class="badge badge-priority-low">LOW</span>
            {% endif %}
          {% else %}
            <span class="text-muted">NOT SPEC</span>
          {% endif %}
        </td>
        <td>{{ p.created_at }}</td>
        <td style="max-width:260px">{{ p.summary }}</td>

        <td class="updates-column">
          <div id="updates-{{ p.id }}">
            {% if p.updates %}
              {% for u in p.updates %}
                <div class="update-item">
                  <div>{{ u.message }}</div>
                  <div class="text-muted small">{{ u.from_email }} · {{ u.created_at }}</div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-muted small">No updates</div>
            {% endif %}
          </div>
        </td>

        <td>
          <button class="btn btn-sm btn-icici w-100"
            data-bs-toggle="modal"
            data-bs-target="#replyModal"
            data-project-id="{{ p.id }}"
            data-project-type="{{ p.project_type }}">
            Reply
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Send reply</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="replyForm">
        <div class="modal-body">
          <input type="hidden" name="project_id" id="modal_project_id">

          <label class="form-label">Subject</label>
          <input id="modal_subject" type="text" class="form-control mb-2" readonly>

          <label class="form-label">Message</label>
          <textarea id="modal_message" class="form-control reply-textarea" required></textarea>

          <div id="replyAlert" class="mt-2" style="display:none;"></div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-icici">Send</button>
          <button type="button" class="btn btn-outline-icici" data-bs-dismiss="modal">Close</button>
        </div>

      </form>

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  var replyModal = document.getElementById('replyModal');

  replyModal.addEventListener('show.bs.modal', function(event) {
    var btn = event.relatedTarget;
    var id = btn.getAttribute('data-project-id');
    var type = btn.getAttribute('data-project-type');

    document.getElementById('modal_project_id').value = id;
    document.getElementById('modal_subject').value =
      "Update on your request: " + type + " (Task " + id + ")";
    document.getElementById('modal_message').value = "";
  });

  document.getElementById('replyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    var pid = modal_project_id.value;
    var msg = modal_message.value.trim();

    var fd = new FormData();
    fd.append("project_id", pid);
    fd.append("reply_message", msg);

    let res = await fetch("/send_reply", { method: "POST", body: fd });
    let j = await res.json();

    if (!j.ok) {
      replyAlert.innerHTML = `<div class="alert alert-danger">${j.error}</div>`;
      replyAlert.style.display = "block";
      return;
    }

    // Inject into updates column
    let box = document.getElementById("updates-" + pid);
    let now = new Date().toLocaleString();
    let div = document.createElement("div");
    div.className = "update-item";
    div.innerHTML =
      `<div>${msg}</div><div class="text-muted small">You · ${now}</div>`;
    box.insertBefore(div, box.firstChild);

    bootstrap.Modal.getInstance(replyModal).hide();
  });
</script>
{% endblock %}
